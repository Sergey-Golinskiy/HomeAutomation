<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Семейный дашборд</title>
  <meta name="color-scheme" content="dark">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    html,body,#root{height:100%} body{margin:0;background:#0E1422;color:#E6E7EA;font-family:system-ui,Segoe UI,Roboto,Arial}
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
/* ===== helpers ===== */
async function loadConfig(){ const r=await fetch('/config.json',{cache:'no-store'}); if(!r.ok) throw new Error('no config'); return r.json(); }
function useClock(){ const [n,setN]=React.useState(new Date()); React.useEffect(()=>{const id=setInterval(()=>setN(new Date()),1000); return ()=>clearInterval(id)},[]); return { date:n.toLocaleDateString(undefined,{weekday:'long',year:'numeric',month:'long',day:'numeric'}), time:n.toLocaleTimeString(undefined,{hour:'2-digit',minute:'2-digit'}) }; }
async function fetchOpenMeteo({lat,lon,tz,tempUnit,windUnit}){ const p=new URLSearchParams({latitude:String(lat),longitude:String(lon),timezone:tz,current:['temperature_2m','apparent_temperature','precipitation','weather_code','wind_speed_10m'].join(','),daily:['temperature_2m_max','temperature_2m_min','precipitation_sum','weather_code'].join(','),forecast_days:'7',temperature_unit:tempUnit==='fahrenheit'?'fahrenheit':'celsius',wind_speed_unit:windUnit||'ms'}); const u=`https://api.open-meteo.com/v1/forecast?${p.toString()}`; const r=await fetch(u); if(!r.ok) throw new Error('openmeteo'); return r.json(); }
const WMO={0:'Ясно',1:'Преимущ. ясно',2:'Переменная облачность',3:'Пасмурно',45:'Туман',48:'Изморозь',51:'Лёгкая морось',53:'Морось',55:'Сильная морось',61:'Небольшой дождь',63:'Дождь',65:'Ливень',71:'Небольшой снег',73:'Снег',75:'Сильный снег',80:'Кратковременный дождь',81:'Сильный кратк. дождь',82:'Очень сильный кратк. дождь',95:'Гроза',96:'Гроза с градом',99:'Сильная гроза с градом'};

/* ===== HA client via server (REST + WS) ===== */
function createHaClient(){
  const listeners=new Set();
  let ws=null;
  function notify(t,p){ listeners.forEach(fn=>fn(t,p)); }

  function connect(){
    const proto=location.protocol==='https:'?'wss':'ws';
    ws=new WebSocket(`${proto}://${location.host}/ws`);
    ws.onmessage=(ev)=>{ const d=JSON.parse(ev.data);
      if(d.type==='auth_ok') notify('connected');
      else if(d.type==='result' && Array.isArray(d.result)) notify('states_snapshot', d.result);
      else if(d.type==='event' && d.event?.event_type==='state_changed') notify('state_changed', d.event.data.new_state);
    };
    ws.onclose=()=>{ notify('disconnected'); setTimeout(connect, 2000); };
  }

  async function callService(domain, service, data){
    const r=await fetch(`/ha/services/${domain}/${service}`,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify(data||{})
    });
    if(!r.ok) throw new Error('service failed'); return r.json();
  }
  async function toggleEntity(entity_id){ return callService('homeassistant','toggle',{entity_id}); }

  return { connect, on:(fn)=> (listeners.add(fn), ()=>listeners.delete(fn)), callService, toggleEntity };
}

function useHA(){
  const [states,setStates]=React.useState({});
  const [online,setOnline]=React.useState(false);

  React.useEffect(()=>{
    const c=createHaClient();
    const off=c.on((t,p)=>{
      if(t==='connected') setOnline(true);
      if(t==='disconnected') setOnline(false);
      if(t==='states_snapshot'){
        const map=Object.fromEntries(p.map(s=>[s.entity_id,s]));
        setStates(map);
      }
      if(t==='state_changed') setStates(prev=>({...prev,[p.entity_id]:p}));
    });
    c.connect();
    return off;
  },[]);
  const clientRef=React.useRef(null);
  if(!clientRef.current) clientRef.current=createHaClient();

  return { states, online, client: clientRef.current };
}

/* ===== UI ===== */
function Card({children}){ return <div className="rounded-2xl bg-[#111726] p-6 shadow-[0_10px_30px_rgba(0,0,0,0.25)]">{children}</div> }

function Header(){ const {date,time}=useClock();
  return <div className="flex items-center justify-between">
    <div>
      <div className="text-5xl font-semibold text-white">{time}</div>
      <div className="text-sm text-[#9AA4B2] mt-1">{date}</div>
    </div>
    <div className="text-right text-sm text-[#9AA4B2]">Семейный дашборд</div>
  </div>;
}

function Weather({cfg}){
  const [d,setD]=React.useState(null);
  React.useEffect(()=>{ let m=true; const L=async()=>{try{ const j=await fetchOpenMeteo({lat:cfg.latitude,lon:cfg.longitude,tz:cfg.timezone,tempUnit:cfg.units.temperature,windUnit:cfg.units.wind}); if(m) setD(j);}catch{}}; L(); const id=setInterval(L,cfg.weatherRefreshMs); return()=>{m=false; clearInterval(id)};},[cfg]);
  if(!d) return <div className="text-[#9AA4B2]">Загрузка погоды…</div>;
  const cur=d.current||{}, daily=d.daily||{};
  return <div>
    <div className="flex items-center justify-between mb-5">
      <div><div className="text-xl font-semibold text-white">Погода</div><div className="text-sm text-[#9AA4B2]">Сегодня и на неделю</div></div>
      <div className="text-right">
        <div className="text-4xl font-semibold text-white">{Math.round(cur.temperature_2m)}°</div>
        <div className="text-xs text-[#9AA4B2]">Ощущается {Math.round(cur.apparent_temperature)}°, ветер {Math.round(cur.wind_speed_10m)} {cfg.units.wind}</div>
        <div className="text-xs text-[#9AA4B2]">{WMO[cur.weather_code]||''}</div>
      </div>
    </div>
    <div className="grid grid-cols-7 gap-3">
      {daily.time?.map((t,i)=>(<div key={t} className="rounded-xl p-3 text-center bg-[#0C111D] border border-[#1C2538]">
        <div className="text-xs text-[#9AA4B2]">{new Date(t).toLocaleDateString(undefined,{weekday:'short'})}</div>
        <div className="text-sm font-medium text-white">{WMO[daily.weather_code?.[i]]||'—'}</div>
        <div className="text-xs text-[#9AA4B2]">{Math.round(daily.temperature_2m_max?.[i])}° / {Math.round(daily.temperature_2m_min?.[i])}°</div>
      </div>))}
    </div>
  </div>;
}

function EntityTile({id,state,onToggle}){
  const on = state?.state==='on';
  const name=state?.attributes?.friendly_name||id;
  return <button onClick={()=>onToggle(id)}
    className={(on?'bg-[#C69A77] text-[#111726]':'bg-[#0C111D] text-white')+
               ' rounded-2xl p-4 text-left w-full transition shadow-[0_8px_20px_rgba(0,0,0,0.25)] border '+
               (on?'border-[#C69A77]':'border-[#1C2538]')}>
    <div className="flex items-center justify-between">
      <div>
        <div className="text-xs uppercase tracking-wide opacity-70">{id.split('.')[0]}</div>
        <div className="text-lg font-medium">{name}</div>
      </div>
      <div className={(on?'bg-[#111726] text-[#C69A77]':'bg-[#1C2538] text-[#9AA4B2]')+' px-3 py-1 rounded-full text-sm'}>
        {on?'ON':'OFF'}
      </div>
    </div>
  </button>;
}

function SensorTile({id,state}){
  const name=state?.attributes?.friendly_name||id;
  const unit=state?.attributes?.unit_of_measurement||'';
  return <div className="rounded-2xl p-4 bg-[#0C111D] text-white shadow-[0_8px_20px_rgba(0,0,0,0.25)] border border-[#1C2538]">
    <div className="text-xs uppercase tracking-wide text-[#9AA4B2]">{id.split('.')[0]}</div>
    <div className="text-lg font-medium">{name}</div>
    <div className="text-3xl font-semibold mt-1">{state?.state??'—'} <span className="text-base font-normal text-[#9AA4B2]">{unit}</span></div>
  </div>;
}

function ScenesRow({ids,onRun}){
  return <div className="flex gap-3 flex-wrap">
    {ids.map(s=>(<button key={s} onClick={()=>onRun(s)} className="rounded-xl px-4 py-2 bg-[#2C7DF0] hover:bg-[#1E5CC3] text-white shadow-[0_8px_20px_rgba(0,0,0,0.25)]">{s.replace('scene.','')}</button>))}
  </div>;
}

function HaPanel({cfg}){
  const {states,online,client}=useHA();
  const {toggles,sensors,scenes}=cfg.ha.entities;
  async function runScene(id){ await client.callService('scene','turn_on',{entity_id:id}); }
  async function toggle(id){ await client.toggleEntity(id); }
  return <div>
    <div className="flex items-center justify-between mb-4">
      <div className="text-xl font-semibold text-white">Устройства Home Assistant</div>
      <div className={'text-sm '+(online?'text-[#2AF09A]':'text-[#E16565]')}>{online?'online':'offline'}</div>
    </div>
    {scenes?.length ? <div className="mb-4"><div className="text-sm text-[#9AA4B2] mb-2">Сцены</div><ScenesRow ids={scenes} onRun={runScene}/></div> : null}
    {toggles?.length ? <div className="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-3 mb-4">
      {toggles.map(id => <EntityTile key={id} id={id} state={states[id]} onToggle={toggle}/>)}
    </div> : null}
    {sensors?.length ? <div className="grid grid-cols-2 md:grid-cols-3 xl:grid-cols-4 gap-3">
      {sensors.map(id => <SensorTile key={id} id={id} state={states[id]}/>)}
    </div> : null}
  </div>;
}

function Slideshow(){
  return <div className="relative w-full h-full overflow-hidden rounded-2xl shadow-[0_10px_30px_rgba(0,0,0,0.25)] bg-black/40">
    <img src="https://images.unsplash.com/photo-1500530855697-b586d89ba3ee?w=1600" className="absolute inset-0 w-full h-full object-cover" alt="photo"/>
  </div>;
}

function App(){
  const [cfg,setCfg]=React.useState(null);
  React.useEffect(()=>{ loadConfig().then(setCfg).catch(console.error); }, []);
  if(!cfg) return <div className="p-6 text-[#9AA4B2]">Загрузка…</div>;
  return <div className="min-h-screen w-full p-4 md:p-6">
    <div className="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-4 md:gap-6">
      <div className="lg:col-span-2 space-y-4 md:space-y-6">
        <Card><Header/></Card>
        <Card><Weather cfg={cfg}/></Card>
        <Card><HaPanel cfg={cfg}/></Card>
      </div>
      <div className="lg:row-span-2 h-[46vh] lg:h-full rounded-2xl overflow-hidden">
        <Slideshow/>
      </div>
      <div className="lg:col-span-2">
        <div className="rounded-2xl border border-[#1C2538] p-6 text-[#9AA4B2] text-sm bg-[#0C111D]">
          Фото можно подключить через /photos/photos.json.
        </div>
      </div>
    </div>
  </div>;
}

const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(<App/>);
  </script>
</body>
</html>
