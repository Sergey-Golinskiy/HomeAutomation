<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Семейный дашборд</title>
  <meta name="color-scheme" content="dark">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    html,body,#root{height:100%}
    body{margin:0;background:#0E1422;color:#E6E7EA;font-family:system-ui,Segoe UI,Roboto,Arial}
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
/* ===== helpers ===== */
async function loadConfig(){
  const r=await fetch('/config.json',{cache:'no-store'});
  if(!r.ok) throw new Error('no config');
  return r.json();
}
function useClock(){
  const [n,setN]=React.useState(new Date());
  React.useEffect(()=>{const id=setInterval(()=>setN(new Date()),1000); return ()=>clearInterval(id)},[]);
  return {
    date:n.toLocaleDateString(undefined,{weekday:'long',year:'numeric',month:'long',day:'numeric'}),
    time:n.toLocaleTimeString(undefined,{hour:'2-digit',minute:'2-digit'})
  };
}
async function fetchOpenMeteo({lat,lon,tz,tempUnit,windUnit}){
  const p=new URLSearchParams({
    latitude:String(lat), longitude:String(lon), timezone:tz,
    current:['temperature_2m','apparent_temperature','precipitation','weather_code','wind_speed_10m'].join(','),
    daily:['temperature_2m_max','temperature_2m_min','precipitation_sum','weather_code'].join(','),
    forecast_days:'7',
    temperature_unit:tempUnit==='fahrenheit'?'fahrenheit':'celsius',
    wind_speed_unit:windUnit||'ms'
  });
  const u=`https://api.open-meteo.com/v1/forecast?${p.toString()}`;
  const r=await fetch(u); if(!r.ok) throw new Error('openmeteo'); return r.json();
}
const WMO={0:'Ясно',1:'Преимущ. ясно',2:'Переменная облачность',3:'Пасмурно',45:'Туман',48:'Изморозь',51:'Лёгкая морось',53:'Морось',55:'Сильная морось',61:'Небольшой дождь',63:'Дождь',65:'Ливень',71:'Небольшой снег',73:'Снег',75:'Сильный снег',80:'Кратковременный дождь',81:'Сильный кратк. дождь',82:'Очень сильный кратк. дождь',95:'Гроза',96:'Гроза с градом',99:'Сильная гроза с градом'};

/* ===== UI ===== */
function Card({children}){ return <div className="rounded-2xl bg-[#111726] p-6 shadow-[0_10px_30px_rgba(0,0,0,0.25)]">{children}</div> }

function Header(){ const {date,time}=useClock();
  return <div className="flex items-center justify-between">
    <div>
      <div className="text-5xl font-semibold text-white">{time}</div>
      <div className="text-sm text-[#9AA4B2] mt-1">{date}</div>
    </div>
    <div className="text-right text-sm text-[#9AA4B2]">Семейный дашборд</div>
  </div>;
}

function Weather({cfg}){
  const [d,setD]=React.useState(null);
  React.useEffect(()=>{ let m=true; const L=async()=>{try{ const j=await fetchOpenMeteo({lat:cfg.latitude,lon:cfg.longitude,tz:cfg.timezone,tempUnit:cfg.units.temperature,windUnit:cfg.units.wind}); if(m) setD(j);}catch{}}; L(); const id=setInterval(L,cfg.weatherRefreshMs); return()=>{m=false; clearInterval(id)};},[cfg]);
  if(!d) return <div className="text-[#9AA4B2]">Загрузка погоды…</div>;
  const cur=d.current||{}, daily=d.daily||{};
  return <div>
    <div className="flex items-center justify-between mb-5">
      <div><div className="text-xl font-semibold text-white">Погода</div><div className="text-sm text-[#9AA4B2]">Сегодня и на неделю</div></div>
      <div className="text-right">
        <div className="text-4xl font-semibold text-white">{Math.round(cur.temperature_2m)}°</div>
        <div className="text-xs text-[#9AA4B2]">Ощущается {Math.round(cur.apparent_temperature)}°, ветер {Math.round(cur.wind_speed_10m)} {cfg.units.wind}</div>
        <div className="text-xs text-[#9AA4B2]">{WMO[cur.weather_code]||''}</div>
      </div>
    </div>
    <div className="grid grid-cols-7 gap-3">
      {daily.time?.map((t,i)=>(<div key={t} className="rounded-xl p-3 text-center bg-[#0C111D] border border-[#1C2538]">
        <div className="text-xs text-[#9AA4B2]">{new Date(t).toLocaleDateString(undefined,{weekday:'short'})}</div>
        <div className="text-sm font-medium text-white">{WMO[daily.weather_code?.[i]]||'—'}</div>
        <div className="text-xs text-[#9AA4B2]">{Math.round(daily.temperature_2m_max?.[i])}° / {Math.round(daily.temperature_2m_min?.[i])}°</div>
      </div>))}
    </div>
  </div>;
}

function Slideshow({cfg}){
  const [images,setImages]=React.useState(cfg.photosFallback||[]);
  const [idx,setIdx]=React.useState(0);
  const timerRef=React.useRef(null);

  // Грузим манифест если есть
  React.useEffect(()=>{
    let act=true;
    const load=async()=>{
      try{
        const r=await fetch(cfg.photosManifestUrl,{cache:'no-store'});
        if(r.ok){
          const json=await r.json();
          if(act && Array.isArray(json.images) && json.images.length) setImages(json.images);
        }
      }catch{}
    };
    load();
    const refresh=setInterval(load, 5*60*1000);
    return ()=>{ act=false; clearInterval(refresh); };
  },[cfg.photosManifestUrl]);

  React.useEffect(()=>{
    timerRef.current && clearInterval(timerRef.current);
    timerRef.current = setInterval(()=> setIdx(i => images.length? (i+1)%images.length : 0), cfg.slideshowIntervalMs);
    return ()=> timerRef.current && clearInterval(timerRef.current);
  },[images, cfg.slideshowIntervalMs]);

  if(!images.length) return <div className="text-[#9AA4B2] p-6">Нет фотографий…</div>;
  const url=images[idx];

  return (
    <div className="relative w-full h-full overflow-hidden rounded-2xl shadow-[0_10px_30px_rgba(0,0,0,0.25)] bg-black/40">
      <img src={url} alt="photo" className="absolute inset-0 w-full h-full object-cover" />
      <div className="absolute bottom-0 left-0 right-0 p-2 text-center text-white/90 text-xs bg-gradient-to-t from-black/40 to-transparent">
        {idx + 1} / {images.length}
      </div>
    </div>
  );
}

function App(){
  const [cfg,setCfg]=React.useState(null);
  React.useEffect(()=>{ loadConfig().then(setCfg).catch(console.error); }, []);
  if(!cfg) return <div className="p-6 text-[#9AA4B2]">Загрузка…</div>;

  /* На lg: grid-cols-4. Слайдшоу 1/4 (25%), контент 3/4 */
  return (
    <div className="min-h-screen w-full p-4 md:p-6">
      <div className="max-w-[1920px] mx-auto grid grid-cols-1 lg:grid-cols-4 gap-4 md:gap-6">
        {/* Левая зона: 3/4 ширины */}
        <div className="lg:col-span-3 space-y-4 md:space-y-6">
          <Card><Header/></Card>
          <Card><Weather cfg={cfg}/></Card>
          {/* здесь можно добавлять другие виджеты */}
        </div>

        {/* Правая колонка: 25% ширины */}
        <div className="lg:col-span-1 rounded-2xl overflow-hidden">
          <div className="h-[46vh] lg:h-auto">
            <Slideshow cfg={cfg}/>
          </div>
        </div>

      </div>
    </div>
  );
}

const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(<App/>);
  </script>
</body>
</html>
